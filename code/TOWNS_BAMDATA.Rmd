---
title: "TOWNS_BAMDATA"
author: "Merritt Harlan"
date: "12/6/2020"
output: html_document
R version: 3.6.1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Functions------
#### extract elevation profiles
```{r  functions, message=FALSE, warning=FALSE}
ortho_lines <- function(DEM, centerline_coords, scale_xs){
  ortho_lines = list()
  UTMcrs = crs(DEM)
  cl_coords_df = data.frame(x=c(1:length(centerline_coords[,1])), lon=centerline_coords[,1], 
                            lat=centerline_coords[,2])
  mean_lon = cl_coords_df$lon[1:(length(cl_coords_df$lon)-1)]+(1/2)*diff(cl_coords_df$lon)
  mean_lat = cl_coords_df$lat[1:(length(cl_coords_df$lat)-1)]+(1/2)*diff(cl_coords_df$lat)
  slope = (-1)/(diff(cl_coords_df$lat)/diff(cl_coords_df$lon))
  for (i in which(!is.na(slope))){
    left_lon = mean_lon-(cos(atan(slope))*scale_xs)
    left_lat = mean_lat-(sin(atan(slope))*scale_xs)
    right_lon = mean_lon+(cos(atan(slope))*scale_xs)
    right_lat = mean_lat+(sin(atan(slope))*scale_xs)
    ortho_lines[[i]] = SpatialLines(list(Lines(Line(cbind(c(left_lon[i],right_lon[i]),
                                                          c(left_lat[i], right_lat[i]))), ID=i)),
                                    proj4string = UTMcrs)
  }
  ortho_lines
}

plot_elev_prof <- function(elev_prof, wse_mat, rivname){
  for(i in 1:length(elev_prof)){
    plot(spline(elev_prof[[i]], n = 1000), main = paste0(rivname, "\n Cross-Section #", i),
         xlab = "Horizontal Distance", ylab = "Elevation (m)", type = "l", 
         ylim = c(min(c(as.numeric(unlist(wse_mat[,i+2])), as.numeric(unlist(elev_prof[[i]]))), na.rm = TRUE), 
                  max(c(as.numeric(unlist(wse_mat[,i+2])), as.numeric(unlist(elev_prof[[i]]))), na.rm = TRUE)))
    points(seq(1, length(unlist(elev_prof[[i]])), length.out = length(unlist(wse_mat[,i+2]))), unlist(wse_mat[,i+2]), 
           pch = 19, col = "blue")
  }
}

#Calculate Width
calc_width <- function(h, elev_prof, upper_l, lower_l, lower_r, upper_r, scale_prof){
  width = matrix(nrow = nrow(h), ncol = length(elev_prof))
  for(xs in 1:length(elev_prof)){
    cropped_elev_prof = elev_prof[[xs]][c(upper_l[xs]:upper_r[xs])]
    s_elev_prof = round(spline(cropped_elev_prof, n=10000)$y, 3)
    scale = (upper_r[xs] - upper_l[xs]) *scale_prof[xs]/10000
    s_left = round(s_elev_prof[1:round((lower_l[xs]- upper_l[xs])*(10000/(upper_r[xs] - upper_l[xs])),0)],1)
    right_start = round((lower_r[xs]-upper_l[xs])*(10000/(upper_r[xs] - upper_l[xs])),0)
    s_right = round(s_elev_prof[right_start:10000],1)
    wse = intersect(s_left, s_right)
    wse = wse[!is.na(wse)]
    width_vec = vector()
    for(i in 1:length(wse)){
      width_vec[i] = (which(s_right==wse[i])[1]+right_start - which(s_left ==wse[i])[1])*scale
    }
    fit = lm(width_vec~wse)
    width[,xs] = as.numeric(unlist(h[,xs]*fit$coefficients[2]+fit$coefficients[1]))
  }
  width
}

#Vector of distances between pt coordinates
calc_xvec <- function(pt_coords_sp, cl){
  coords = cl@lines[[1]]@Lines[[1]]@coords
  csum = cumsum(pointDistance(coords[1:(nrow(coords)-1),], coords[2:nrow(coords),], lonlat = FALSE))
  dist_mat = pointDistance(pt_coords_sp, data.frame(cl@lines[[1]]@Lines[[1]]@coords))
  xvec = csum[apply(dist_mat, 1, FUN = which.min)]
  return(xvec)
}

#Calculate dA
#Calculate area
#' Calculate partial cross-section area from DAWG-formatted width and height matrices
#' @param w Matrix of widths
#' @param h Matrix of heights(FROM MARK)
calcdA_mat <- function(w, h) {
  stopifnot(all(dim(w) == dim(h)))
  dA <- w
  for (i in 1:nrow(dA)) {
    dA[i, ] <- calcdA_vec(w[i, ], h[i, ])
  }
  dA
}


#' Calculate partial cross-section area from width and height vectors (time series)
#' @param w vector of widths
#' @param h vector of heights(FROM MARK)
calcdA_vec <- function(w, h) {
  words <- order(w)
  warr <- w[words]
  harr <- h[words]
  delh <- c(0, diff(as.numeric(harr)))
  delA <- cumsum(warr * delh)
  dA <- 1:length(w)
  dA[words] <- delA
  dA
}

#Calculate slope
#' Calculate slope based on height and along-river distance
#' @param xvec vector of x (along-stream) distances, measured from
#' upstream-most cross-section
#' @param hmat Matrix (space-down, time-across) of stream heights above
#'arbitrary datum.(FROM MARK)
calcslope <- function(xvec, hmat) {
  dH <- apply(hmat, 2, function(x) c(NA, -diff(x)))
  dX_vec <- c(NA, diff(xvec))
  dX <- matrix(dX_vec, ncol = ncol(hmat), nrow = nrow(hmat),
               byrow = FALSE)
  out <- dH / dX
}



```

## Tanana
#### Load centerline data and pressure transducer locations
```{r Tanana spatial, message=FALSE, warning=FALSE}
library(sf)
library(raster)

wd = getwd()
setwd("../input/TOWNS/Centerline/")
Tanana_cl <- shapefile("Tan_cl.shp")
setwd(wd)
Tanana_PT_coords <- read.csv("../input/TOWNS/PT_coords/Tanana_PT_coords.csv")


Tanana_bounding_box <- c(min(Tanana_PT_coords$Longitude)-10000, max(Tanana_PT_coords$Longitude)+10000,
                      min(Tanana_PT_coords$Latitude)-10000, max(Tanana_PT_coords$Latitude)+10000)



```
#### Get elevation data and DEM

```{r Tanana DEM, message=FALSE, warning=FALSE}
library(doParallel)
Tanana_WSE_daily <- readRDS("../input/TOWNS/WSE/Tanana_WSE_Q_daily.rds")
Tanana_DEM <- raster("../input/TOWNS/DEM/Tanana_DEM.tif")

Tanana_orthos <- ortho_lines(Tanana_DEM, data.frame(Tanana_cl@lines[[1]]@Lines[[1]]@coords), 5000)

#Find closest orthos to pressure transducers
Tanana_PT_coords_sp <-SpatialPoints(Tanana_PT_coords[,3:4], proj4string = crs(Tanana_DEM))
Tanana_dist_mat <- pointDistance(Tanana_PT_coords_sp, data.frame(Tanana_cl@lines[[1]]@Lines[[1]]@coords))
Tanana_closest_ortho <- Tanana_orthos[apply(Tanana_dist_mat, 1, FUN = which.min)]

plot(Tanana_PT_coords_sp)
for(i in 1:length(Tanana_closest_ortho)){
  plot(Tanana_closest_ortho[[i]], add = TRUE, col = "blue")
}
#copy cross section profile code at specific location

numcores <- detectCores()
cl<-makeCluster(numcores-1)
registerDoParallel(cl)
ptm<-proc.time()
Tanana_elev_prof <- foreach(i=1:length(Tanana_closest_ortho), 
                                  .combine='rbind', .packages=c('raster')) %dopar% {
                                    extract(Tanana_DEM, Tanana_closest_ortho[[i]], method = 'simple')
                                  }
proc.time()-ptm
stopCluster(cl)

Tanana_scale_x <- vector()
for(i in 1:length(Tanana_elev_prof)){
  Tanana_scale_x[i] = 10000/length(Tanana_elev_prof[[i]])
}

plot_elev_prof(Tanana_elev_prof, Tanana_WSE_daily, "Tanana")
#locator(n = 4)
#manually locate the left and right banks on the x axis
Tanana_upper_l <- c(3097.0,  2169.1, 3746.5, 1942.7, 1901.9,  3464.3,  2322.4, 1163.8,     0, 2781.0, 1426.2, 1582.6)
Tanana_lower_l <- c(3404.9,  2378.4, 3923.6, 2102.3, 2090.9,  3652.7,  2495.4, 1842.6,  119.7, 2942.2, 1645.2, 1718.1)
Tanana_lower_r <- c(4205.5,  2587.7, 4744.7, 4512.3, 4485.7,  5865.8,  5482.6, 3816.1, 2755.6, 6592.2, 4192.5, 5134.8)
Tanana_upper_r <- c(4344.1,  2716.5, 4937.9, 4671.9, 4596.0,  5959.9,  5592.7, 4100.2, 2980.7, 6797.5, 4423.1, 5378.8)

```
#### Calculate width, dA, and slope

```{r Tanana width, message=FALSE, warning=FALSE}
library(gtools)

xvec <- rev(calc_xvec(Tanana_PT_coords_sp, Tanana_cl))

Tanana_WSE_daily <- readRDS("../input/TOWNS/WSE/Tanana_WSE_Q_daily.rds")
Tanana_width_daily <- t(calc_width(h = Tanana_WSE_daily[,c(3:ncol(Tanana_WSE_daily))], elev_prof = Tanana_elev_prof, 
                                  upper_l = Tanana_upper_l, lower_l = Tanana_lower_l,
                                  lower_r = Tanana_lower_r, upper_r = Tanana_upper_r,
                                  scale_prof = Tanana_scale_x))
Tanana_dA_daily <- calcdA_mat(w = Tanana_width_daily, h = t(Tanana_WSE_daily[,c(3:ncol(Tanana_WSE_daily))]))
Tanana_slope_daily <- calcslope(xvec, hmat = t(Tanana_WSE_daily[,c(3:ncol(Tanana_WSE_daily))]))
Tanana_slope_daily <- na.replace(Tanana_slope_daily, mean(Tanana_slope_daily))
Tanana_slope_daily[1,] <- colMeans(Tanana_slope_daily, na.rm = TRUE)

Tanana_WSE_6_hrs <- readRDS("../input/TOWNS/WSE/Tanana_WSE_Q_6_hrs.rds")
Tanana_width_6_hrs <- t(calc_width(h = Tanana_WSE_6_hrs[,c(3:ncol(Tanana_WSE_6_hrs))], elev_prof = Tanana_elev_prof, 
                                  upper_l = Tanana_upper_l, lower_l = Tanana_lower_l,
                                  lower_r = Tanana_lower_r, upper_r = Tanana_upper_r,
                                  scale_prof = Tanana_scale_x))
Tanana_dA_6_hrs <- calcdA_mat(w = Tanana_width_6_hrs, h = t(Tanana_WSE_6_hrs[,c(3:ncol(Tanana_WSE_6_hrs))]))
Tanana_slope_6_hrs <- calcslope(xvec, hmat = t(Tanana_WSE_6_hrs[,c(3:ncol(Tanana_WSE_6_hrs))]))
Tanana_slope_6_hrs <- na.replace(Tanana_slope_6_hrs, mean(Tanana_slope_6_hrs))
Tanana_slope_6_hrs[1,] <- colMeans(Tanana_slope_6_hrs, na.rm = TRUE)

Tanana_WSE_hourly <- readRDS("../input/TOWNS/WSE/Tanana_WSE_Q_hourly.rds")
Tanana_width_hourly <- t(calc_width(h = Tanana_WSE_hourly[,c(3:ncol(Tanana_WSE_hourly))], elev_prof = Tanana_elev_prof, 
                                  upper_l = Tanana_upper_l, lower_l = Tanana_lower_l,
                                  lower_r = Tanana_lower_r, upper_r = Tanana_upper_r,
                                  scale_prof = Tanana_scale_x))
Tanana_dA_hourly <- calcdA_mat(w = Tanana_width_hourly, h = t(Tanana_WSE_hourly[,c(3:ncol(Tanana_WSE_hourly))]))
Tanana_slope_hourly <- calcslope(xvec, hmat = t(Tanana_WSE_hourly[,c(3:ncol(Tanana_WSE_hourly))]))
Tanana_slope_hourly <- na.replace(Tanana_slope_hourly, mean(Tanana_slope_hourly))
Tanana_slope_hourly[1,] <- colMeans(Tanana_slope_hourly, na.rm = TRUE)

Tanana_WSE_15_min <- readRDS("../input/TOWNS/WSE/Tanana_WSE_Q_15_min.rds")
Tanana_width_15_min <- t(calc_width(h = Tanana_WSE_15_min[,c(3:ncol(Tanana_WSE_15_min))], elev_prof = Tanana_elev_prof, 
                                  upper_l = Tanana_upper_l, lower_l = Tanana_lower_l,
                                  lower_r = Tanana_lower_r, upper_r = Tanana_upper_r,
                                  scale_prof = Tanana_scale_x))
Tanana_dA_15_min <- calcdA_mat(w = Tanana_width_15_min, h = t(Tanana_WSE_15_min[,c(3:ncol(Tanana_WSE_15_min))]))
Tanana_slope_15_min <- calcslope(xvec, hmat = t(Tanana_WSE_15_min[,c(3:ncol(Tanana_WSE_15_min))]))
Tanana_slope_15_min <- na.replace(Tanana_slope_15_min, mean(Tanana_slope_15_min))
Tanana_slope_15_min[1,] <- colMeans(Tanana_slope_15_min, na.rm = TRUE)

```





#### format and save bamdata
```{r Tanana save, message=FALSE, warning=FALSE}
library(bamr)
library(zoo)
Tanana_bam_daily = bam_data(w = Tanana_width_daily, s = Tanana_slope_daily, dA = Tanana_slope_daily, Qhat = as.numeric(unlist(Tanana_WSE_daily[,2])))

Tanana_bam_6_hrs = bam_data(w = Tanana_width_6_hrs, s = Tanana_slope_6_hrs, dA = Tanana_slope_6_hrs, Qhat = as.numeric(unlist(Tanana_WSE_6_hrs[,2])))

Tanana_bam_hourly = bam_data(w = Tanana_width_hourly, s = Tanana_slope_hourly, dA = Tanana_slope_hourly, Qhat = as.numeric(unlist(Tanana_WSE_hourly[,2])))

Tanana_bam_15_min = bam_data(w = Tanana_width_15_min, s = Tanana_slope_15_min, dA = Tanana_slope_15_min, Qhat = as.numeric(unlist(Tanana_WSE_15_min[,2])))

saveRDS(Tanana_bam_daily, "../input/TOWNS/BAMdata/Tanana_bam_daily.rds")
saveRDS(Tanana_bam_6_hrs, "../input/TOWNS/BAMdata/Tanana_bam_6_hrs.rds")
saveRDS(Tanana_bam_hourly, "../input/TOWNS/BAMdata/Tanana_bam_hourly.rds")
saveRDS(Tanana_bam_15_min, "../input/TOWNS/BAMdata/Tanana_bam_15_min.rds")

```


## Olentangy
#### Load centerline data and pressure transducer locations
```{r Olentangy spatial, message=FALSE, warning=FALSE}
library(sf)
library(raster)

wd = getwd()
setwd("../input/TOWNS/Centerline/")
Olentangy_cl <- shapefile("Olen_cl_UTM.shp")
setwd(wd)
Olentangy_PT_coords <- read.csv("../input/TOWNS/PT_coords/Olen_PT_coords.csv")

```
#### Get elevation data and DEM

```{r Olentangy DEM, message=FALSE, warning=FALSE}
library(doParallel)
Olentangy_WSE_daily <- readRDS("../input/TOWNS/WSE/Olentangy_WSE_Q_daily.rds")
Olentangy_DEM <- raster("../input/TOWNS/DEM/Olentangy_DEM.tif")

Olentangy_orthos <- ortho_lines(Olentangy_DEM, data.frame(Olentangy_cl@lines[[1]]@Lines[[1]]@coords), 100)

#Find closest orthos to pressure transducers
Olentangy_PT_coords_sp <-SpatialPoints(Olentangy_PT_coords[,3:4], proj4string = crs(Olentangy_DEM))
Olentangy_dist_mat <- pointDistance(Olentangy_PT_coords_sp, data.frame(Olentangy_cl@lines[[1]]@Lines[[1]]@coords))
Olentangy_closest_ortho <- Olentangy_orthos[apply(Olentangy_dist_mat, 1, FUN = which.min)]

plot(Olentangy_PT_coords_sp)
for(i in 1:length(Olentangy_closest_ortho)){
  plot(Olentangy_closest_ortho[[i]], add = TRUE, col = "blue")
}
#copy cross section profile code at specific location

numcores <- detectCores()
cl<-makeCluster(numcores-1)
registerDoParallel(cl)
ptm<-proc.time()
Olentangy_elev_prof <- foreach(i=1:length(Olentangy_closest_ortho), 
                                  .combine='rbind', .packages=c('raster')) %dopar% {
                                    extract(Olentangy_DEM, Olentangy_closest_ortho[[i]], method = 'simple')
                                  }
proc.time()-ptm
stopCluster(cl)

Olentangy_scale_x <- vector()
for(i in 1:length(Olentangy_elev_prof)){
  Olentangy_scale_x[i] = 200/length(Olentangy_elev_prof[[i]])
}

plot_elev_prof(Olentangy_elev_prof, Olentangy_WSE_daily, "Olentangy")
#locator(n = 4)
Olentangy_upper_l <- c( 8.2,  8.1,  3.2,  3.3, 11.5,  4.6, 11.2, 10.3, 11.4,  7.1,  6.5, 11.3,  9.8,  1.4, 12.3,  8.7,  8.2,  8.9,  6.3, 11.5)
Olentangy_lower_l <- c(10.5, 10.2,  5.2,  5.3, 13.2,  7.1, 13.3, 12.3, 13.3,  9.8, 10.3, 13.2, 11.3, 13.1, 14.3, 10.6, 10.4, 11.3,  7.9, 13.3)
Olentangy_lower_r <- c(15.7, 18.5, 18.4, 25.6, 21.6, 12.7, 17.7, 18.7, 18.6, 19.5, 16.6, 20.5, 20.7, 15.7, 20.7, 15.8, 16.7, 16.4, 21.8, 20.0)
Olentangy_upper_r <- c(19.4, 21.1, 21.2, 27.5, 23.7, 15.8, 20.8, 23.4, 22.0, 21.6, 20.4, 22.8, 22.5, 18.1, 24.6, 18.0, 20.5, 20, 23.7, 23.1)

```

#### Calculate width, dA, and slope

```{r Olentangy width, message=FALSE, warning=FALSE}
library(gtools)

xvec <- rev(calc_xvec(Olentangy_PT_coords_sp, Olentangy_cl))

Olentangy_WSE_daily <- readRDS("../input/TOWNS/WSE/Olentangy_WSE_Q_daily.rds")
Olentangy_width_daily <- t(calc_width(h = Olentangy_WSE_daily[,c(3:ncol(Olentangy_WSE_daily))], elev_prof = Olentangy_elev_prof, 
                                  upper_l = Olentangy_upper_l, lower_l = Olentangy_lower_l,
                                  lower_r = Olentangy_lower_r, upper_r = Olentangy_upper_r,
                                  scale_prof = Olentangy_scale_x))
Olentangy_dA_daily <- calcdA_mat(w = Olentangy_width_daily, h = t(Olentangy_WSE_daily[,c(3:ncol(Olentangy_WSE_daily))]))
Olentangy_slope_daily <- calcslope(xvec, hmat = t(Olentangy_WSE_daily[,c(3:ncol(Olentangy_WSE_daily))]))
Olentangy_slope_daily <- na.replace(Olentangy_slope_daily, mean(Olentangy_slope_daily))
Olentangy_slope_daily[1,] <- colMeans(Olentangy_slope_daily, na.rm = TRUE)

Olentangy_WSE_6_hrs <- readRDS("../input/TOWNS/WSE/Olentangy_WSE_Q_6_hrs.rds")
Olentangy_width_6_hrs <- t(calc_width(h = Olentangy_WSE_6_hrs[,c(3:ncol(Olentangy_WSE_6_hrs))], elev_prof = Olentangy_elev_prof, 
                                  upper_l = Olentangy_upper_l, lower_l = Olentangy_lower_l,
                                  lower_r = Olentangy_lower_r, upper_r = Olentangy_upper_r,
                                  scale_prof = Olentangy_scale_x))
Olentangy_dA_6_hrs <- calcdA_mat(w = Olentangy_width_6_hrs, h = t(Olentangy_WSE_6_hrs[,c(3:ncol(Olentangy_WSE_6_hrs))]))
Olentangy_slope_6_hrs <- calcslope(xvec, hmat = t(Olentangy_WSE_6_hrs[,c(3:ncol(Olentangy_WSE_6_hrs))]))
Olentangy_slope_6_hrs <- na.replace(Olentangy_slope_6_hrs, mean(Olentangy_slope_6_hrs))
Olentangy_slope_6_hrs[1,] <- colMeans(Olentangy_slope_6_hrs, na.rm = TRUE)

Olentangy_WSE_hourly <- readRDS("../input/TOWNS/WSE/Olentangy_WSE_Q_hourly.rds")
Olentangy_width_hourly <- t(calc_width(h = Olentangy_WSE_hourly[,c(3:ncol(Olentangy_WSE_hourly))], elev_prof = Olentangy_elev_prof, 
                                  upper_l = Olentangy_upper_l, lower_l = Olentangy_lower_l,
                                  lower_r = Olentangy_lower_r, upper_r = Olentangy_upper_r,
                                  scale_prof = Olentangy_scale_x))
Olentangy_dA_hourly <- calcdA_mat(w = Olentangy_width_hourly, h = t(Olentangy_WSE_hourly[,c(3:ncol(Olentangy_WSE_hourly))]))
Olentangy_slope_hourly <- calcslope(xvec, hmat = t(Olentangy_WSE_hourly[,c(3:ncol(Olentangy_WSE_hourly))]))
Olentangy_slope_hourly <- na.replace(Olentangy_slope_hourly, mean(Olentangy_slope_hourly))
Olentangy_slope_hourly[1,] <- colMeans(Olentangy_slope_hourly, na.rm = TRUE)

Olentangy_WSE_15_min <- readRDS("../input/TOWNS/WSE/Olentangy_WSE_Q_15_min.rds")
Olentangy_width_15_min <- t(calc_width(h = Olentangy_WSE_15_min[,c(3:ncol(Olentangy_WSE_15_min))], elev_prof = Olentangy_elev_prof, 
                                  upper_l = Olentangy_upper_l, lower_l = Olentangy_lower_l,
                                  lower_r = Olentangy_lower_r, upper_r = Olentangy_upper_r,
                                  scale_prof = Olentangy_scale_x))
Olentangy_dA_15_min <- calcdA_mat(w = Olentangy_width_15_min, h = t(Olentangy_WSE_15_min[,c(3:ncol(Olentangy_WSE_15_min))]))
Olentangy_slope_15_min <- calcslope(xvec, hmat = t(Olentangy_WSE_15_min[,c(3:ncol(Olentangy_WSE_15_min))]))
Olentangy_slope_15_min <- na.replace(Olentangy_slope_15_min, mean(Olentangy_slope_15_min))
Olentangy_slope_15_min[1,] <- colMeans(Olentangy_slope_15_min, na.rm = TRUE)


```





#### format and save bamdata
```{r Olentangy save, message=FALSE, warning=FALSE}
library(bamr)
Olentangy_bam_daily = bam_data(w = Olentangy_width_daily, s = Olentangy_slope_daily, dA = Olentangy_slope_daily, Qhat = as.numeric(unlist(Olentangy_WSE_daily[,2])))

Olentangy_bam_6_hrs = bam_data(w = Olentangy_width_6_hrs, s = Olentangy_slope_6_hrs, dA = Olentangy_slope_6_hrs, Qhat = as.numeric(unlist(Olentangy_WSE_6_hrs[,2])))

Olentangy_bam_hourly = bam_data(w = Olentangy_width_hourly, s = Olentangy_slope_hourly, dA = Olentangy_slope_hourly, Qhat = as.numeric(unlist(Olentangy_WSE_hourly[,2])))

Olentangy_bam_15_min = bam_data(w = Olentangy_width_15_min, s = Olentangy_slope_15_min, dA = Olentangy_slope_15_min, Qhat = as.numeric(unlist(Olentangy_WSE_15_min[,2])))

saveRDS(Olentangy_bam_daily, "../input/TOWNS/BAMdata/Olentangy_bam_daily.rds")
saveRDS(Olentangy_bam_6_hrs, "../input/TOWNS/BAMdata/Olentangy_bam_6_hrs.rds")
saveRDS(Olentangy_bam_hourly, "../input/TOWNS/BAMdata/Olentangy_bam_hourly.rds")
saveRDS(Olentangy_bam_15_min, "../input/TOWNS/BAMdata/Olentangy_bam_15_min.rds")

```

## Willamette
#### Load centerline data and pressure transducer locations
```{r Willamette spatial, message=FALSE, warning=FALSE}
library(sf)
library(raster)

wd = getwd()
setwd("../input/TOWNS/Centerline/")
Willamette_cl <- shapefile("Will_cl_UTM.shp")
setwd(wd)
Willamette_PT_coords <- read.csv("../input/TOWNS/PT_coords/Willamette_PT_coords.csv")

```
#### Get elevation data and DEM

```{r Willamette DEM, message=FALSE, warning=FALSE}
library(doParallel)
Willamette_WSE_daily <- readRDS("../input/TOWNS/WSE/Willamette_WSE_Q_daily.rds")
Willamette_DEM <- raster("../input/TOWNS/DEM/Willamette_DEM.tif")

Willamette_orthos <- ortho_lines(Willamette_DEM, data.frame(Willamette_cl@lines[[1]]@Lines[[1]]@coords), 500)

#Find closest orthos to pressure transducers
Willamette_PT_coords_sp <-SpatialPoints(Willamette_PT_coords[,3:4], proj4string = crs(Willamette_DEM))
Willamette_dist_mat <- pointDistance(Willamette_PT_coords_sp, data.frame(Willamette_cl@lines[[1]]@Lines[[1]]@coords))
Willamette_closest_ortho <- Willamette_orthos[apply(Willamette_dist_mat, 1, FUN = which.min)]

plot(Willamette_PT_coords_sp)
for(i in 1:length(Willamette_closest_ortho)){
  plot(Willamette_closest_ortho[[i]], add = TRUE, col = "blue")
}
#copy cross section profile code at specific location

numcores <- detectCores()
cl<-makeCluster(numcores-1)
registerDoParallel(cl)
ptm<-proc.time()
Willamette_elev_prof <- foreach(i=1:length(Willamette_closest_ortho), 
                                  .combine='rbind', .packages=c('raster')) %dopar% {
                                    extract(Willamette_DEM, Willamette_closest_ortho[[i]], method = 'simple')
                                  }
proc.time()-ptm
stopCluster(cl)

Willamette_scale_x <- vector()
for(i in 1:length(Willamette_elev_prof)){
  Willamette_scale_x[i] = 1000/length(Willamette_elev_prof[[i]])
}

plot_elev_prof(Willamette_elev_prof, Willamette_WSE_daily, "Willamette")
#locator(n = 4)
Willamette_upper_l <- c(57.1, 56.2, 71.9,  66.9, 70.3, 65.7,  69.2,  73.6,  68.0, 43.7, 62.8, 61.9, 35.0, 55.1, 64.2, 69.8, 73.6, 60.2, 71.8, 54.4, 90.5)
Willamette_lower_l <- c(63.2, 60.9, 77.8,  74.1, 74.7, 70.1,  75.4,  78.2,  72.6, 46.9, 67.9, 65.5, 38.3, 59.5, 69.3, 75.5, 79.3, 64.0, 75.7, 58.6, 95.8)
Willamette_lower_r <- c(75.9, 68.9, 88.6,  96.5, 92.4, 78.8, 111.1, 107.3,  96.9, 58.3, 80.1, 85.3, 59.3, 78.0, 93.4, 92.9, 89.1, 72.0, 87.2, 63.7, 114.9)
Willamette_upper_r <- c(80.2, 73.0, 96.3, 101.2, 97.4, 86.1, 116.6, 113.8, 102.3, 60.3, 86.4, 88.4, 62.4, 82.8, 97.2, 97.2, 94.5, 76.8, 90.9, 68.6, 120.0)

```

#### Calculate width, dA, and slope

```{r Willamette width, message=FALSE, warning=FALSE}
library(gtools)

xvec <-calc_xvec(Willamette_PT_coords_sp, Willamette_cl)

Willamette_WSE_daily <- readRDS("../input/TOWNS/WSE/Willamette_WSE_Q_daily.rds")
Willamette_width_daily <- t(calc_width(h = Willamette_WSE_daily[,c(3:ncol(Willamette_WSE_daily))], elev_prof = Willamette_elev_prof, 
                                  upper_l = Willamette_upper_l, lower_l = Willamette_lower_l,
                                  lower_r = Willamette_lower_r, upper_r = Willamette_upper_r,
                                  scale_prof = Willamette_scale_x))
Willamette_dA_daily <- calcdA_mat(w = Willamette_width_daily, h = t(Willamette_WSE_daily[,c(3:ncol(Willamette_WSE_daily))]))
Willamette_slope_daily <- calcslope(xvec, hmat = t(Willamette_WSE_daily[,c(3:ncol(Willamette_WSE_daily))]))
Willamette_slope_daily <- na.replace(Willamette_slope_daily, mean(Willamette_slope_daily))
Willamette_slope_daily[1,] <- colMeans(Willamette_slope_daily, na.rm = TRUE)

Willamette_WSE_6_hrs <- readRDS("../input/TOWNS/WSE/Willamette_WSE_Q_6_hrs.rds")
Willamette_width_6_hrs <- t(calc_width(h = Willamette_WSE_6_hrs[,c(3:ncol(Willamette_WSE_6_hrs))], elev_prof = Willamette_elev_prof, 
                                  upper_l = Willamette_upper_l, lower_l = Willamette_lower_l,
                                  lower_r = Willamette_lower_r, upper_r = Willamette_upper_r,
                                  scale_prof = Willamette_scale_x))
Willamette_dA_6_hrs <- calcdA_mat(w = Willamette_width_6_hrs, h = t(Willamette_WSE_6_hrs[,c(3:ncol(Willamette_WSE_6_hrs))]))
Willamette_slope_6_hrs <- calcslope(xvec, hmat = t(Willamette_WSE_6_hrs[,c(3:ncol(Willamette_WSE_6_hrs))]))
Willamette_slope_6_hrs <- na.replace(Willamette_slope_6_hrs, mean(Willamette_slope_6_hrs))
Willamette_slope_6_hrs[1,] <- colMeans(Willamette_slope_6_hrs, na.rm = TRUE)

Willamette_WSE_hourly <- readRDS("../input/TOWNS/WSE/Willamette_WSE_Q_hourly.rds")
Willamette_width_hourly <- t(calc_width(h = Willamette_WSE_hourly[,c(3:ncol(Willamette_WSE_hourly))], elev_prof = Willamette_elev_prof, 
                                  upper_l = Willamette_upper_l, lower_l = Willamette_lower_l,
                                  lower_r = Willamette_lower_r, upper_r = Willamette_upper_r,
                                  scale_prof = Willamette_scale_x))
Willamette_dA_hourly <- calcdA_mat(w = Willamette_width_hourly, h = t(Willamette_WSE_hourly[,c(3:ncol(Willamette_WSE_hourly))]))
Willamette_slope_hourly <- calcslope(xvec, hmat = t(Willamette_WSE_hourly[,c(3:ncol(Willamette_WSE_hourly))]))
Willamette_slope_hourly <- na.replace(Willamette_slope_hourly, mean(Willamette_slope_hourly))
Willamette_slope_hourly[1,] <- colMeans(Willamette_slope_hourly, na.rm = TRUE)

Willamette_WSE_15_min <- readRDS("../input/TOWNS/WSE/Willamette_WSE_Q_15_min.rds")
Willamette_width_15_min <- t(calc_width(h = Willamette_WSE_15_min[,c(3:ncol(Willamette_WSE_15_min))], elev_prof = Willamette_elev_prof, 
                                  upper_l = Willamette_upper_l, lower_l = Willamette_lower_l,
                                  lower_r = Willamette_lower_r, upper_r = Willamette_upper_r,
                                  scale_prof = Willamette_scale_x))
Willamette_dA_15_min <- calcdA_mat(w = Willamette_width_15_min, h = t(Willamette_WSE_15_min[,c(3:ncol(Willamette_WSE_15_min))]))
Willamette_slope_15_min <- calcslope(xvec, hmat = t(Willamette_WSE_15_min[,c(3:ncol(Willamette_WSE_15_min))]))
Willamette_slope_15_min <- na.replace(Willamette_slope_15_min, mean(Willamette_slope_15_min))
Willamette_slope_15_min[1,] <- colMeans(Willamette_slope_15_min, na.rm = TRUE)


```





#### format and save bamdata
```{r Willamette save, message=FALSE, warning=FALSE}
library(bamr)
Willamette_bam_daily = bam_data(w = Willamette_width_daily, s = Willamette_slope_daily, dA = Willamette_slope_daily, Qhat = as.numeric(unlist(Willamette_WSE_daily[,2])))

Willamette_bam_6_hrs = bam_data(w = Willamette_width_6_hrs, s = Willamette_slope_6_hrs, dA = Willamette_slope_6_hrs, Qhat = as.numeric(unlist(Willamette_WSE_6_hrs[,2])))

Willamette_bam_hourly = bam_data(w = Willamette_width_hourly, s = Willamette_slope_hourly, dA = Willamette_slope_hourly, Qhat = as.numeric(unlist(Willamette_WSE_hourly[,2])))

Willamette_bam_15_min = bam_data(w = Willamette_width_15_min, s = Willamette_slope_15_min, dA = Willamette_slope_15_min, Qhat = as.numeric(unlist(Willamette_WSE_15_min[,2])))

saveRDS(Willamette_bam_daily, "../input/TOWNS/BAMdata/Willamette_bam_daily.rds")
saveRDS(Willamette_bam_6_hrs, "../input/TOWNS/BAMdata/Willamette_bam_6_hrs.rds")
saveRDS(Willamette_bam_hourly, "../input/TOWNS/BAMdata/Willamette_bam_hourly.rds")
saveRDS(Willamette_bam_15_min, "../input/TOWNS/BAMdata/Willamette_bam_15_min.rds")

```


## North_Sask
#### Load centerline data and pressure transducer locations
```{r North_Sask spatial, message=FALSE, warning=FALSE}
library(sf)
library(raster)

wd = getwd()
setwd("../input/TOWNS/Centerline/")
North_Sask_cl <- shapefile("North_Sask_cl_UTM.shp")
setwd(wd)
North_Sask_PT_coords <- read.csv("../input/TOWNS/PT_coords/North_Sask_PT_coords.csv")
North_Sask_PT_coords_sp <-SpatialPoints(North_Sask_PT_coords[,4:3], proj4string =CRS("+init=epsg:4326"))


```
#### Get elevation data and DEM

```{r North_Sask DEM, message=FALSE, warning=FALSE}
library(doParallel)
North_Sask_WSE_daily <- readRDS("../input/TOWNS/WSE/North_Sask_WSE_Q_daily.rds")
North_Sask_DEM <- raster("../input/TOWNS/DEM/North_Sask_DEM.tif")

North_Sask_PT_coords_sp <- spTransform(North_Sask_PT_coords_sp, crs(North_Sask_DEM))
North_Sask_orthos <- ortho_lines(North_Sask_DEM, data.frame(North_Sask_cl@lines[[1]]@Lines[[1]]@coords), 500)

#Find closest orthos to pressure transducers
North_Sask_dist_mat <- pointDistance(North_Sask_PT_coords_sp, data.frame(North_Sask_cl@lines[[1]]@Lines[[1]]@coords))
North_Sask_closest_ortho <- North_Sask_orthos[apply(North_Sask_dist_mat, 1, FUN = which.min)]

plot(North_Sask_PT_coords_sp)
for(i in 1:length(North_Sask_closest_ortho)){
  plot(North_Sask_closest_ortho[[i]], add = TRUE, col = "blue")
}
#copy cross section profile code at specific location

numcores <- detectCores()
cl<-makeCluster(numcores-1)
registerDoParallel(cl)
ptm<-proc.time()
North_Sask_elev_prof <- foreach(i=1:length(North_Sask_closest_ortho), 
                                  .combine='rbind', .packages=c('raster')) %dopar% {
                                    extract(North_Sask_DEM, North_Sask_closest_ortho[[i]], method = 'simple')
                                  }
proc.time()-ptm
stopCluster(cl)

North_Sask_scale_x <- vector()
for(i in 1:length(North_Sask_elev_prof)){
  North_Sask_scale_x[i] = 1000/length(North_Sask_elev_prof[[i]])
}

plot_elev_prof(North_Sask_elev_prof, North_Sask_WSE_daily, "North_Sask")
#locator(n = 4)
North_Sask_upper_l <- c(22.6,  7.2, 19.7, 29.4, 23.0, 23.5, 29.4,  1.7, 2.2)
North_Sask_lower_l <- c(29.3, 10.0, 28.3, 35.3, 25.5, 28.9, 33.7, 23.4, 30.6)
North_Sask_lower_r <- c(46.5, 43.6, 71.6, 50.2, 39.9, 44.4, 43.4, 55.2, 49.0)
North_Sask_upper_r <- c(51.9, 49.4, 76.2, 53.7, 43.9, 53.8, 50.0, 65.6, 61.7)
```

#### Calculate width, dA, and slope

```{r North_Sask width, message=FALSE, warning=FALSE}
library(gtools)

xvec <-calc_xvec(North_Sask_PT_coords_sp, North_Sask_cl)

North_Sask_WSE_daily <- readRDS("../input/TOWNS/WSE/North_Sask_WSE_Q_daily.rds")
North_Sask_width_daily <- t(calc_width(h = North_Sask_WSE_daily[,c(3:ncol(North_Sask_WSE_daily))], elev_prof = North_Sask_elev_prof, 
                                  upper_l = North_Sask_upper_l, lower_l = North_Sask_lower_l,
                                  lower_r = North_Sask_lower_r, upper_r = North_Sask_upper_r,
                                  scale_prof = North_Sask_scale_x))
North_Sask_dA_daily <- calcdA_mat(w = North_Sask_width_daily, h = t(North_Sask_WSE_daily[,c(3:ncol(North_Sask_WSE_daily))]))
North_Sask_slope_daily <- calcslope(xvec, hmat = t(North_Sask_WSE_daily[,c(3:ncol(North_Sask_WSE_daily))]))
North_Sask_slope_daily <- na.replace(North_Sask_slope_daily, mean(North_Sask_slope_daily))
North_Sask_slope_daily[1,] <- colMeans(North_Sask_slope_daily, na.rm = TRUE)

North_Sask_WSE_6_hrs <- readRDS("../input/TOWNS/WSE/North_Sask_WSE_Q_6_hrs.rds")
North_Sask_width_6_hrs <- t(calc_width(h = North_Sask_WSE_6_hrs[,c(3:ncol(North_Sask_WSE_6_hrs))], elev_prof = North_Sask_elev_prof, 
                                  upper_l = North_Sask_upper_l, lower_l = North_Sask_lower_l,
                                  lower_r = North_Sask_lower_r, upper_r = North_Sask_upper_r,
                                  scale_prof = North_Sask_scale_x))
North_Sask_dA_6_hrs <- calcdA_mat(w = North_Sask_width_6_hrs, h = t(North_Sask_WSE_6_hrs[,c(3:ncol(North_Sask_WSE_6_hrs))]))
North_Sask_slope_6_hrs <- calcslope(xvec, hmat = t(North_Sask_WSE_6_hrs[,c(3:ncol(North_Sask_WSE_6_hrs))]))
North_Sask_slope_6_hrs <- na.replace(North_Sask_slope_6_hrs, mean(North_Sask_slope_6_hrs))
North_Sask_slope_6_hrs[1,] <- colMeans(North_Sask_slope_6_hrs, na.rm = TRUE)

North_Sask_WSE_hourly <- readRDS("../input/TOWNS/WSE/North_Sask_WSE_Q_hourly.rds")
North_Sask_width_hourly <- t(calc_width(h = North_Sask_WSE_hourly[,c(3:ncol(North_Sask_WSE_hourly))], elev_prof = North_Sask_elev_prof, 
                                  upper_l = North_Sask_upper_l, lower_l = North_Sask_lower_l,
                                  lower_r = North_Sask_lower_r, upper_r = North_Sask_upper_r,
                                  scale_prof = North_Sask_scale_x))
North_Sask_dA_hourly <- calcdA_mat(w = North_Sask_width_hourly, h = t(North_Sask_WSE_hourly[,c(3:ncol(North_Sask_WSE_hourly))]))
North_Sask_slope_hourly <- calcslope(xvec, hmat = t(North_Sask_WSE_hourly[,c(3:ncol(North_Sask_WSE_hourly))]))
North_Sask_slope_hourly <- na.replace(North_Sask_slope_hourly, mean(North_Sask_slope_hourly))
North_Sask_slope_hourly[1,] <- colMeans(North_Sask_slope_hourly, na.rm = TRUE)

North_Sask_WSE_15_min <- readRDS("../input/TOWNS/WSE/North_Sask_WSE_Q_15_min.rds")
North_Sask_width_15_min <- t(calc_width(h = North_Sask_WSE_15_min[,c(3:ncol(North_Sask_WSE_15_min))], elev_prof = North_Sask_elev_prof, 
                                  upper_l = North_Sask_upper_l, lower_l = North_Sask_lower_l,
                                  lower_r = North_Sask_lower_r, upper_r = North_Sask_upper_r,
                                  scale_prof = North_Sask_scale_x))
North_Sask_dA_15_min <- calcdA_mat(w = North_Sask_width_15_min, h = t(North_Sask_WSE_15_min[,c(3:ncol(North_Sask_WSE_15_min))]))
North_Sask_slope_15_min <- calcslope(xvec, hmat = t(North_Sask_WSE_15_min[,c(3:ncol(North_Sask_WSE_15_min))]))
North_Sask_slope_15_min <- na.replace(North_Sask_slope_15_min, mean(North_Sask_slope_15_min))
North_Sask_slope_15_min[1,] <- colMeans(North_Sask_slope_15_min, na.rm = TRUE)


```





#### format and save bamdata
```{r North_Sask save, message=FALSE, warning=FALSE}
library(bamr)
North_Sask_bam_daily = bam_data(w = North_Sask_width_daily, s = North_Sask_slope_daily, dA = North_Sask_slope_daily, Qhat = as.numeric(unlist(North_Sask_WSE_daily[,2])))

North_Sask_bam_6_hrs = bam_data(w = North_Sask_width_6_hrs, s = North_Sask_slope_6_hrs, dA = North_Sask_slope_6_hrs, Qhat = as.numeric(unlist(North_Sask_WSE_6_hrs[,2])))

North_Sask_bam_hourly = bam_data(w = North_Sask_width_hourly, s = North_Sask_slope_hourly, dA = North_Sask_slope_hourly, Qhat = as.numeric(unlist(North_Sask_WSE_hourly[,2])))

North_Sask_bam_15_min = bam_data(w = North_Sask_width_15_min, s = North_Sask_slope_15_min, dA = North_Sask_slope_15_min, Qhat = as.numeric(unlist(North_Sask_WSE_15_min[,2])))

saveRDS(North_Sask_bam_daily, "../input/TOWNS/BAMdata/North_Sask_bam_daily.rds")
saveRDS(North_Sask_bam_6_hrs, "../input/TOWNS/BAMdata/North_Sask_bam_6_hrs.rds")
saveRDS(North_Sask_bam_hourly, "../input/TOWNS/BAMdata/North_Sask_bam_hourly.rds")
saveRDS(North_Sask_bam_15_min, "../input/TOWNS/BAMdata/North_Sask_bam_15_min.rds")

```

## Sacramento_R1
#### Load centerline data and pressure transducer locations
```{r Sacramento_R1 spatial, message=FALSE, warning=FALSE}
library(sf)
library(raster)

wd = getwd()
setwd("../input/TOWNS/Centerline/")
Sacramento_R1_cl <- shapefile("Sac_rch1_UTM.shp")
setwd(wd)
Sacramento_R1_PT_coords <- read.csv("../input/TOWNS/PT_coords/Sac_rch1_PT_coords.csv")
```
#### Get elevation data and DEM

```{r Sacramento_R1 DEM, message=FALSE, warning=FALSE}
library(doParallel)
Sacramento_R1_WSE_daily <- readRDS("../input/TOWNS/WSE/Sacramento_R1_WSE_Q_daily.rds")
Sacramento_R1_DEM <- raster("../input/TOWNS/DEM/Sacramento_R1_DEM.tif")

Sacramento_R1_orthos <- ortho_lines(Sacramento_R1_DEM, data.frame(Sacramento_R1_cl@lines[[1]]@Lines[[1]]@coords), 500)

#Find closest orthos to pressure transducers
Sacramento_R1_PT_coords_sp <- SpatialPoints(Sacramento_R1_PT_coords[,5:4], proj4string = crs(Sacramento_R1_DEM))
Sacramento_R1_dist_mat <- pointDistance(Sacramento_R1_PT_coords_sp, data.frame(Sacramento_R1_cl@lines[[1]]@Lines[[1]]@coords))
Sacramento_R1_closest_ortho <- Sacramento_R1_orthos[apply(Sacramento_R1_dist_mat, 1, FUN = which.min)]

plot(Sacramento_R1_PT_coords_sp)
for(i in 1:length(Sacramento_R1_closest_ortho)){
  plot(Sacramento_R1_closest_ortho[[i]], add = TRUE, col = "blue")
}
#copy cross section profile code at specific location

numcores <- detectCores()
cl<-makeCluster(numcores-1)
registerDoParallel(cl)
ptm<-proc.time()
Sacramento_R1_elev_prof <- foreach(i=1:length(Sacramento_R1_closest_ortho), 
                                  .combine='rbind', .packages=c('raster')) %dopar% {
                                    extract(Sacramento_R1_DEM, Sacramento_R1_closest_ortho[[i]], method = 'simple')
                                  }
proc.time()-ptm
stopCluster(cl)

Sacramento_R1_scale_x <- vector()
for(i in 1:length(Sacramento_R1_elev_prof)){
  Sacramento_R1_scale_x[i] = 1000/length(Sacramento_R1_elev_prof[[i]])
}

Sacramento_R1_WSE_daily
plot_elev_prof(Sacramento_R1_elev_prof, Sacramento_R1_WSE_daily, "Sacramento_R1")
#locator(n = 4)
Sacramento_R1_upper_l <- c(33.6, 67.9,    0,  32.8,  32.8, 33.5, 33.5, 38.8, 61.3, 71.7)
Sacramento_R1_lower_l <- c(56.8, 71.4,  3.0,  53.3,  53.3, 50.8, 50.8, 45.9, 65.9, 76.3)
Sacramento_R1_lower_r <- c(68.6, 75.4, 10.1,  64.9,  64.9, 65.3, 65.3, 52.4, 70.2, 81.3)
Sacramento_R1_upper_r <- c(86.2, 79.2, 21.8, 108.0, 108.0, 77.4, 77.4, 58.7, 75.6, 87.5)

Sacramento_R1_elev_prof_corr <- Sacramento_R1_elev_prof[c(1:4, 4, 7, 7, 8, 9, 10)]
Sacramento_R1_elev_prof_corr[[6]] <- Sacramento_R1_elev_prof[[6]] - 4
Sacramento_R1_elev_prof_corr[[7]] <- Sacramento_R1_elev_prof[[7]] - 4
Sacramento_R1_elev_prof_corr[[8]] <- Sacramento_R1_elev_prof[[8]] - 4
Sacramento_R1_elev_prof_corr[[9]] <- Sacramento_R1_elev_prof[[9]] - 4
Sacramento_R1_elev_prof_corr[[10]] <- Sacramento_R1_elev_prof[[10]] - 4
Sacramento_R1_scale_x <- Sacramento_R1_scale_x[c(1:4, 4, 7, 7, 8, 9, 10)]
```

#### Calculate width, dA, and slope

```{r Sacramento_R1 width, message=FALSE, warning=FALSE}
library(gtools)

xvec <-rev(calc_xvec(Sacramento_R1_PT_coords_sp, Sacramento_R1_cl))

Sacramento_R1_WSE_daily <- readRDS("../input/TOWNS/WSE/Sacramento_R1_WSE_Q_daily.rds")
Sacramento_R1_width_daily <- t(calc_width(h = Sacramento_R1_WSE_daily[,c(3:ncol(Sacramento_R1_WSE_daily))], 
                                          elev_prof = Sacramento_R1_elev_prof_corr,
                                          upper_l = Sacramento_R1_upper_l, lower_l = Sacramento_R1_lower_l,
                                  lower_r = Sacramento_R1_lower_r, upper_r = Sacramento_R1_upper_r,
                                  scale_prof = Sacramento_R1_scale_x))
Sacramento_R1_dA_daily <- calcdA_mat(w = Sacramento_R1_width_daily, h = t(Sacramento_R1_WSE_daily[,c(3:ncol(Sacramento_R1_WSE_daily))]))
Sacramento_R1_slope_daily <- calcslope(xvec, hmat = t(Sacramento_R1_WSE_daily[,c(3:ncol(Sacramento_R1_WSE_daily))]))
Sacramento_R1_slope_daily <- na.replace(Sacramento_R1_slope_daily, mean(Sacramento_R1_slope_daily))
Sacramento_R1_slope_daily[1,] <- colMeans(Sacramento_R1_slope_daily, na.rm = TRUE)

Sacramento_R1_WSE_6_hrs <- readRDS("../input/TOWNS/WSE/Sacramento_R1_WSE_Q_6_hrs.rds")
Sacramento_R1_width_6_hrs <- t(calc_width(h = Sacramento_R1_WSE_6_hrs[,c(3:ncol(Sacramento_R1_WSE_6_hrs))], elev_prof = Sacramento_R1_elev_prof, 
                                  upper_l = Sacramento_R1_upper_l, lower_l = Sacramento_R1_lower_l,
                                  lower_r = Sacramento_R1_lower_r, upper_r = Sacramento_R1_upper_r,
                                  scale_prof = Sacramento_R1_scale_x))
Sacramento_R1_dA_6_hrs <- calcdA_mat(w = Sacramento_R1_width_6_hrs, h = t(Sacramento_R1_WSE_6_hrs[,c(3:ncol(Sacramento_R1_WSE_6_hrs))]))
Sacramento_R1_slope_6_hrs <- calcslope(xvec, hmat = t(Sacramento_R1_WSE_6_hrs[,c(3:ncol(Sacramento_R1_WSE_6_hrs))]))
Sacramento_R1_slope_6_hrs <- na.replace(Sacramento_R1_slope_6_hrs, mean(Sacramento_R1_slope_6_hrs))
Sacramento_R1_slope_6_hrs[1,] <- colMeans(Sacramento_R1_slope_6_hrs, na.rm = TRUE)

Sacramento_R1_WSE_hourly <- readRDS("../input/TOWNS/WSE/Sacramento_R1_WSE_Q_hourly.rds")
Sacramento_R1_width_hourly <- t(calc_width(h = Sacramento_R1_WSE_hourly[,c(3:ncol(Sacramento_R1_WSE_hourly))], elev_prof = Sacramento_R1_elev_prof, 
                                  upper_l = Sacramento_R1_upper_l, lower_l = Sacramento_R1_lower_l,
                                  lower_r = Sacramento_R1_lower_r, upper_r = Sacramento_R1_upper_r,
                                  scale_prof = Sacramento_R1_scale_x))
Sacramento_R1_dA_hourly <- calcdA_mat(w = Sacramento_R1_width_hourly, h = t(Sacramento_R1_WSE_hourly[,c(3:ncol(Sacramento_R1_WSE_hourly))]))
Sacramento_R1_slope_hourly <- calcslope(xvec, hmat = t(Sacramento_R1_WSE_hourly[,c(3:ncol(Sacramento_R1_WSE_hourly))]))
Sacramento_R1_slope_hourly <- na.replace(Sacramento_R1_slope_hourly, mean(Sacramento_R1_slope_hourly))
Sacramento_R1_slope_hourly[1,] <- colMeans(Sacramento_R1_slope_hourly, na.rm = TRUE)

Sacramento_R1_WSE_15_min <- readRDS("../input/TOWNS/WSE/Sacramento_R1_WSE_Q_15_min.rds")
Sacramento_R1_width_15_min <- t(calc_width(h = Sacramento_R1_WSE_15_min[,c(3:ncol(Sacramento_R1_WSE_15_min))], elev_prof = Sacramento_R1_elev_prof, 
                                  upper_l = Sacramento_R1_upper_l, lower_l = Sacramento_R1_lower_l,
                                  lower_r = Sacramento_R1_lower_r, upper_r = Sacramento_R1_upper_r,
                                  scale_prof = Sacramento_R1_scale_x))
Sacramento_R1_dA_15_min <- calcdA_mat(w = Sacramento_R1_width_15_min, h = t(Sacramento_R1_WSE_15_min[,c(3:ncol(Sacramento_R1_WSE_15_min))]))
Sacramento_R1_slope_15_min <- calcslope(xvec, hmat = t(Sacramento_R1_WSE_15_min[,c(3:ncol(Sacramento_R1_WSE_15_min))]))
Sacramento_R1_slope_15_min <- na.replace(Sacramento_R1_slope_15_min, mean(Sacramento_R1_slope_15_min))
Sacramento_R1_slope_15_min[1,] <- colMeans(Sacramento_R1_slope_15_min, na.rm = TRUE)


```





#### format and save bamdata
```{r Sacramento_R1 save, message=FALSE, warning=FALSE}
library(bamr)
Sacramento_R1_bam_daily = bam_data(w = Sacramento_R1_width_daily, s = Sacramento_R1_slope_daily, dA = Sacramento_R1_slope_daily, Qhat = as.numeric(unlist(Sacramento_R1_WSE_daily[,2])))

Sacramento_R1_bam_6_hrs = bam_data(w = Sacramento_R1_width_6_hrs, s = Sacramento_R1_slope_6_hrs, dA = Sacramento_R1_slope_6_hrs, Qhat = as.numeric(unlist(Sacramento_R1_WSE_6_hrs[,2])))

Sacramento_R1_bam_hourly = bam_data(w = Sacramento_R1_width_hourly, s = Sacramento_R1_slope_hourly, dA = Sacramento_R1_slope_hourly, Qhat = as.numeric(unlist(Sacramento_R1_WSE_hourly[,2])))

Sacramento_R1_bam_15_min = bam_data(w = Sacramento_R1_width_15_min, s = Sacramento_R1_slope_15_min, dA = Sacramento_R1_slope_15_min, Qhat = as.numeric(unlist(Sacramento_R1_WSE_15_min[,2])))

saveRDS(Sacramento_R1_bam_daily, "../input/TOWNS/BAMdata/Sacramento_R1_bam_daily.rds")
saveRDS(Sacramento_R1_bam_6_hrs, "../input/TOWNS/BAMdata/Sacramento_R1_bam_6_hrs.rds")
saveRDS(Sacramento_R1_bam_hourly, "../input/TOWNS/BAMdata/Sacramento_R1_bam_hourly.rds")
saveRDS(Sacramento_R1_bam_15_min, "../input/TOWNS/BAMdata/Sacramento_R1_bam_15_min.rds")

```


## Sacramento_R2
#### Load centerline data and pressure transducer locations
```{r Sacramento_R2 spatial, message=FALSE, warning=FALSE}
library(sf)
library(raster)

wd = getwd()
setwd("../input/TOWNS/Centerline/")
Sacramento_R2_cl <- shapefile("Sac_rch2_UTM.shp")
setwd(wd)
Sacramento_R2_PT_coords <- read.csv("../input/TOWNS/PT_coords/Sac_rch2_PT_coords.csv")
```
#### Get elevation data and DEM

```{r Sacramento_R2 DEM, message=FALSE, warning=FALSE}
library(doParallel)
Sacramento_R2_WSE_daily <- readRDS("../input/TOWNS/WSE/Sacramento_R2_WSE_Q_daily.rds")
Sacramento_R2_DEM <- raster("../input/TOWNS/DEM/Sacramento_R2_DEM.tif")

Sacramento_R2_orthos <- ortho_lines(Sacramento_R2_DEM, data.frame(Sacramento_R2_cl@lines[[1]]@Lines[[1]]@coords), 500)

#Find closest orthos to pressure transducers
Sacramento_R2_PT_coords_sp <- SpatialPoints(Sacramento_R2_PT_coords[,5:4], proj4string = crs(Sacramento_R2_DEM))
Sacramento_R2_dist_mat <- pointDistance(Sacramento_R2_PT_coords_sp, data.frame(Sacramento_R2_cl@lines[[1]]@Lines[[1]]@coords))
Sacramento_R2_closest_ortho <- Sacramento_R2_orthos[apply(Sacramento_R2_dist_mat, 1, FUN = which.min)]

plot(Sacramento_R2_PT_coords_sp)
for(i in 1:length(Sacramento_R2_closest_ortho)){
  plot(Sacramento_R2_closest_ortho[[i]], add = TRUE, col = "blue")
}
#copy cross section profile code at specific location

numcores <- detectCores()
cl<-makeCluster(numcores-1)
registerDoParallel(cl)
ptm<-proc.time()
Sacramento_R2_elev_prof <- foreach(i=1:length(Sacramento_R2_closest_ortho), 
                                  .combine='rbind', .packages=c('raster')) %dopar% {
                                    extract(Sacramento_R2_DEM, Sacramento_R2_closest_ortho[[i]], method = 'simple')
                                  }
proc.time()-ptm
stopCluster(cl)

Sacramento_R2_scale_x <- vector()
for(i in 1:length(Sacramento_R2_elev_prof)){
  Sacramento_R2_scale_x[i] = 1000/length(Sacramento_R2_elev_prof[[i]])
}

plot_elev_prof(Sacramento_R2_elev_prof, Sacramento_R2_WSE_daily, "Sacramento_R2")
#locator(n = 4)
Sacramento_R2_upper_l <- c(67.8, 64.3, 59.7, 41.9, 60.3, 60.5)
Sacramento_R2_lower_l <- c(77.2, 71.1, 78.2, 49.3, 73.2, 78.2)
Sacramento_R2_lower_r <- c(82.1, 75.2, 83.7, 55.7, 84.4, 81.7)
Sacramento_R2_upper_r <- c(91.5, 86.5, 92.4, 60.6, 96.4, 104.1)

Sacramento_R2_elev_prof_corr <- Sacramento_R2_elev_prof
Sacramento_R2_elev_prof_corr[[1]] <- Sacramento_R2_elev_prof[[1]] - 3
Sacramento_R2_elev_prof_corr[[2]] <- Sacramento_R2_elev_prof[[2]] - 3
Sacramento_R2_elev_prof_corr[[3]] <- Sacramento_R2_elev_prof[[3]] - 3
Sacramento_R2_elev_prof_corr[[4]] <- Sacramento_R2_elev_prof[[4]] - 3
Sacramento_R2_elev_prof_corr[[5]] <- Sacramento_R2_elev_prof[[5]] - 3
Sacramento_R2_elev_prof_corr[[6]] <- Sacramento_R2_elev_prof[[6]] - 3

```

#### Calculate width, dA, and slope

```{r Sacramento_R2 width, message=FALSE, warning=FALSE}
library(gtools)

xvec <-rev(calc_xvec(Sacramento_R2_PT_coords_sp, Sacramento_R2_cl))

Sacramento_R2_WSE_daily <- readRDS("../input/TOWNS/WSE/Sacramento_R2_WSE_Q_daily.rds")
Sacramento_R2_width_daily <- t(calc_width(h = Sacramento_R2_WSE_daily[,c(3:ncol(Sacramento_R2_WSE_daily))], 
                                          elev_prof = Sacramento_R2_elev_prof_corr,
                                          upper_l = Sacramento_R2_upper_l, lower_l = Sacramento_R2_lower_l,
                                  lower_r = Sacramento_R2_lower_r, upper_r = Sacramento_R2_upper_r,
                                  scale_prof = Sacramento_R2_scale_x))
Sacramento_R2_dA_daily <- calcdA_mat(w = Sacramento_R2_width_daily, h = t(Sacramento_R2_WSE_daily[,c(3:ncol(Sacramento_R2_WSE_daily))]))
Sacramento_R2_slope_daily <- calcslope(xvec, hmat = t(Sacramento_R2_WSE_daily[,c(3:ncol(Sacramento_R2_WSE_daily))]))
Sacramento_R2_slope_daily <- na.replace(Sacramento_R2_slope_daily, mean(Sacramento_R2_slope_daily))
Sacramento_R2_slope_daily[1,] <- colMeans(Sacramento_R2_slope_daily, na.rm = TRUE)

Sacramento_R2_WSE_6_hrs <- readRDS("../input/TOWNS/WSE/Sacramento_R2_WSE_Q_6_hrs.rds")
Sacramento_R2_width_6_hrs <- t(calc_width(h = Sacramento_R2_WSE_6_hrs[,c(3:ncol(Sacramento_R2_WSE_6_hrs))], elev_prof = Sacramento_R2_elev_prof, 
                                  upper_l = Sacramento_R2_upper_l, lower_l = Sacramento_R2_lower_l,
                                  lower_r = Sacramento_R2_lower_r, upper_r = Sacramento_R2_upper_r,
                                  scale_prof = Sacramento_R2_scale_x))
Sacramento_R2_dA_6_hrs <- calcdA_mat(w = Sacramento_R2_width_6_hrs, h = t(Sacramento_R2_WSE_6_hrs[,c(3:ncol(Sacramento_R2_WSE_6_hrs))]))
Sacramento_R2_slope_6_hrs <- calcslope(xvec, hmat = t(Sacramento_R2_WSE_6_hrs[,c(3:ncol(Sacramento_R2_WSE_6_hrs))]))
Sacramento_R2_slope_6_hrs <- na.replace(Sacramento_R2_slope_6_hrs, mean(Sacramento_R2_slope_6_hrs))
Sacramento_R2_slope_6_hrs[1,] <- colMeans(Sacramento_R2_slope_6_hrs, na.rm = TRUE)

Sacramento_R2_WSE_hourly <- readRDS("../input/TOWNS/WSE/Sacramento_R2_WSE_Q_hourly.rds")
Sacramento_R2_width_hourly <- t(calc_width(h = Sacramento_R2_WSE_hourly[,c(3:ncol(Sacramento_R2_WSE_hourly))], elev_prof = Sacramento_R2_elev_prof, 
                                  upper_l = Sacramento_R2_upper_l, lower_l = Sacramento_R2_lower_l,
                                  lower_r = Sacramento_R2_lower_r, upper_r = Sacramento_R2_upper_r,
                                  scale_prof = Sacramento_R2_scale_x))
Sacramento_R2_dA_hourly <- calcdA_mat(w = Sacramento_R2_width_hourly, h = t(Sacramento_R2_WSE_hourly[,c(3:ncol(Sacramento_R2_WSE_hourly))]))
Sacramento_R2_slope_hourly <- calcslope(xvec, hmat = t(Sacramento_R2_WSE_hourly[,c(3:ncol(Sacramento_R2_WSE_hourly))]))
Sacramento_R2_slope_hourly <- na.replace(Sacramento_R2_slope_hourly, mean(Sacramento_R2_slope_hourly))
Sacramento_R2_slope_hourly[1,] <- colMeans(Sacramento_R2_slope_hourly, na.rm = TRUE)

Sacramento_R2_WSE_15_min <- readRDS("../input/TOWNS/WSE/Sacramento_R2_WSE_Q_15_min.rds")
Sacramento_R2_width_15_min <- t(calc_width(h = Sacramento_R2_WSE_15_min[,c(3:ncol(Sacramento_R2_WSE_15_min))], elev_prof = Sacramento_R2_elev_prof, 
                                  upper_l = Sacramento_R2_upper_l, lower_l = Sacramento_R2_lower_l,
                                  lower_r = Sacramento_R2_lower_r, upper_r = Sacramento_R2_upper_r,
                                  scale_prof = Sacramento_R2_scale_x))
Sacramento_R2_dA_15_min <- calcdA_mat(w = Sacramento_R2_width_15_min, h = t(Sacramento_R2_WSE_15_min[,c(3:ncol(Sacramento_R2_WSE_15_min))]))
Sacramento_R2_slope_15_min <- calcslope(xvec, hmat = t(Sacramento_R2_WSE_15_min[,c(3:ncol(Sacramento_R2_WSE_15_min))]))
Sacramento_R2_slope_15_min <- na.replace(Sacramento_R2_slope_15_min, mean(Sacramento_R2_slope_15_min))
Sacramento_R2_slope_15_min[1,] <- colMeans(Sacramento_R2_slope_15_min, na.rm = TRUE)


```





#### format and save bamdata
```{r Sacramento_R2 save, message=FALSE, warning=FALSE}
library(bamr)
Sacramento_R2_bam_daily = bam_data(w = Sacramento_R2_width_daily, s = Sacramento_R2_slope_daily, dA = Sacramento_R2_slope_daily, Qhat = as.numeric(unlist(Sacramento_R2_WSE_daily[,2])))

Sacramento_R2_bam_6_hrs = bam_data(w = Sacramento_R2_width_6_hrs, s = Sacramento_R2_slope_6_hrs, dA = Sacramento_R2_slope_6_hrs, Qhat = as.numeric(unlist(Sacramento_R2_WSE_6_hrs[,2])))

Sacramento_R2_bam_hourly = bam_data(w = Sacramento_R2_width_hourly, s = Sacramento_R2_slope_hourly, dA = Sacramento_R2_slope_hourly, Qhat = as.numeric(unlist(Sacramento_R2_WSE_hourly[,2])))

Sacramento_R2_bam_15_min = bam_data(w = Sacramento_R2_width_15_min, s = Sacramento_R2_slope_15_min, dA = Sacramento_R2_slope_15_min, Qhat = as.numeric(unlist(Sacramento_R2_WSE_15_min[,2])))

saveRDS(Sacramento_R2_bam_daily, "../input/TOWNS/BAMdata/Sacramento_R2_bam_daily.rds")
saveRDS(Sacramento_R2_bam_6_hrs, "../input/TOWNS/BAMdata/Sacramento_R2_bam_6_hrs.rds")
saveRDS(Sacramento_R2_bam_hourly, "../input/TOWNS/BAMdata/Sacramento_R2_bam_hourly.rds")
saveRDS(Sacramento_R2_bam_15_min, "../input/TOWNS/BAMdata/Sacramento_R2_bam_15_min.rds")

```



## Sacramento_R3
#### Load centerline data and pressure transducer locations
```{r Sacramento_R3 spatial, message=FALSE, warning=FALSE}
library(sf)
library(raster)

wd = getwd()
setwd("../input/TOWNS/Centerline/")
Sacramento_R3_cl <- shapefile("Sac_rch3_cl_UTM.shp")
setwd(wd)
Sacramento_R3_PT_coords <- read.csv("../input/TOWNS/PT_coords/Sac_rch3_PT_coords.csv")
```
#### Get elevation data and DEM

```{r Sacramento_R3 DEM, message=FALSE, warning=FALSE}
library(doParallel)
Sacramento_R3_WSE_daily <- readRDS("../input/TOWNS/WSE/Sacramento_R3_WSE_Q_daily.rds")
Sacramento_R3_DEM <- raster("../input/TOWNS/DEM/Sacramento_R3_DEM.tif")

Sacramento_R3_orthos <- ortho_lines(Sacramento_R3_DEM, data.frame(Sacramento_R3_cl@lines[[1]]@Lines[[1]]@coords), 500)

#Find closest orthos to pressure transducers
Sacramento_R3_PT_coords_sp <- SpatialPoints(Sacramento_R3_PT_coords[,5:4], proj4string = crs(Sacramento_R3_DEM))
Sacramento_R3_dist_mat <- pointDistance(Sacramento_R3_PT_coords_sp, data.frame(Sacramento_R3_cl@lines[[1]]@Lines[[1]]@coords))
Sacramento_R3_closest_ortho <- Sacramento_R3_orthos[apply(Sacramento_R3_dist_mat, 1, FUN = which.min)]

plot(Sacramento_R3_PT_coords_sp)
for(i in 1:length(Sacramento_R3_closest_ortho)){
  plot(Sacramento_R3_closest_ortho[[i]], add = TRUE, col = "blue")
}
#copy cross section profile code at specific location

numcores <- detectCores()
cl<-makeCluster(numcores-1)
registerDoParallel(cl)
ptm<-proc.time()
Sacramento_R3_elev_prof <- foreach(i=1:length(Sacramento_R3_closest_ortho), 
                                  .combine='rbind', .packages=c('raster')) %dopar% {
                                    extract(Sacramento_R3_DEM, Sacramento_R3_closest_ortho[[i]], method = 'simple')
                                  }
proc.time()-ptm
stopCluster(cl)

Sacramento_R3_scale_x <- vector()
for(i in 1:length(Sacramento_R3_elev_prof)){
  Sacramento_R3_scale_x[i] = 1000/length(Sacramento_R3_elev_prof[[i]])
}

plot_elev_prof(Sacramento_R3_elev_prof, Sacramento_R3_WSE_daily, "Sacramento_R3")
#locator(n = 4)
Sacramento_R3_upper_l <- c( 82.6, 50.2,  56.2, 67.7, 68.8, 46.8, 53.5, 64.2,  53.3, 46.9, 42.6, 49.3, 49.3, 65.7, 66.6, 66.2, 56.4, 46.7, 37.4)
Sacramento_R3_lower_l <- c( 88.9, 54.6,  59.8, 72.9, 76.0, 53.6, 56.4, 70.1,  57.6, 49.3, 45.3, 53.7, 53.7, 69.2, 70.5, 72.7, 59.9, 50.4, 41.0)
Sacramento_R3_lower_r <- c(116.4, 91.8, 100.8, 87.7, 88.2, 68.3, 85.2, 84.3, 107.9, 88.8, 74.1, 66.6, 66.6, 77.5, 86.0, 88.5, 72.5, 66.0, 59.5)
Sacramento_R3_upper_r <- c(125.6, 95.3, 104.0, 93.4, 91.8, 71.3, 88.3, 88.9, 111.0, 92.2, 77.4, 70.8, 70.8, 81.0, 90.0, 95.7, 77.5, 69.7, 63.3)

Sacramento_R3_elev_prof_corr <- Sacramento_R3_elev_prof
Sacramento_R3_elev_prof_corr[[12]] <- Sacramento_R3_elev_prof[[13]]
Sacramento_R3_scale_x[12] <- Sacramento_R3_scale_x[13]


```

#### Calculate width, dA, and slope

```{r Sacramento_R3 width, message=FALSE, warning=FALSE}
library(gtools)

xvec <-rev(calc_xvec(Sacramento_R3_PT_coords_sp, Sacramento_R3_cl))

Sacramento_R3_WSE_daily <- readRDS("../input/TOWNS/WSE/Sacramento_R3_WSE_Q_daily.rds")
Sacramento_R3_width_daily <- t(calc_width(h = Sacramento_R3_WSE_daily[,c(3:ncol(Sacramento_R3_WSE_daily))], 
                                          elev_prof = Sacramento_R3_elev_prof_corr,
                                          upper_l = Sacramento_R3_upper_l, lower_l = Sacramento_R3_lower_l,
                                  lower_r = Sacramento_R3_lower_r, upper_r = Sacramento_R3_upper_r,
                                  scale_prof = Sacramento_R3_scale_x))
Sacramento_R3_dA_daily <- calcdA_mat(w = Sacramento_R3_width_daily, h = t(Sacramento_R3_WSE_daily[,c(3:ncol(Sacramento_R3_WSE_daily))]))
Sacramento_R3_slope_daily <- calcslope(xvec, hmat = t(Sacramento_R3_WSE_daily[,c(3:ncol(Sacramento_R3_WSE_daily))]))
Sacramento_R3_slope_daily <- na.replace(Sacramento_R3_slope_daily, mean(Sacramento_R3_slope_daily))
Sacramento_R3_slope_daily[1,] <- colMeans(Sacramento_R3_slope_daily, na.rm = TRUE)

Sacramento_R3_WSE_6_hrs <- readRDS("../input/TOWNS/WSE/Sacramento_R3_WSE_Q_6_hrs.rds")
Sacramento_R3_width_6_hrs <- t(calc_width(h = Sacramento_R3_WSE_6_hrs[,c(3:ncol(Sacramento_R3_WSE_6_hrs))], elev_prof = Sacramento_R3_elev_prof, 
                                  upper_l = Sacramento_R3_upper_l, lower_l = Sacramento_R3_lower_l,
                                  lower_r = Sacramento_R3_lower_r, upper_r = Sacramento_R3_upper_r,
                                  scale_prof = Sacramento_R3_scale_x))
Sacramento_R3_dA_6_hrs <- calcdA_mat(w = Sacramento_R3_width_6_hrs, h = t(Sacramento_R3_WSE_6_hrs[,c(3:ncol(Sacramento_R3_WSE_6_hrs))]))
Sacramento_R3_slope_6_hrs <- calcslope(xvec, hmat = t(Sacramento_R3_WSE_6_hrs[,c(3:ncol(Sacramento_R3_WSE_6_hrs))]))
Sacramento_R3_slope_6_hrs <- na.replace(Sacramento_R3_slope_6_hrs, mean(Sacramento_R3_slope_6_hrs))
Sacramento_R3_slope_6_hrs[1,] <- colMeans(Sacramento_R3_slope_6_hrs, na.rm = TRUE)

Sacramento_R3_WSE_hourly <- readRDS("../input/TOWNS/WSE/Sacramento_R3_WSE_Q_hourly.rds")
Sacramento_R3_width_hourly <- t(calc_width(h = Sacramento_R3_WSE_hourly[,c(3:ncol(Sacramento_R3_WSE_hourly))], elev_prof = Sacramento_R3_elev_prof, 
                                  upper_l = Sacramento_R3_upper_l, lower_l = Sacramento_R3_lower_l,
                                  lower_r = Sacramento_R3_lower_r, upper_r = Sacramento_R3_upper_r,
                                  scale_prof = Sacramento_R3_scale_x))
Sacramento_R3_dA_hourly <- calcdA_mat(w = Sacramento_R3_width_hourly, h = t(Sacramento_R3_WSE_hourly[,c(3:ncol(Sacramento_R3_WSE_hourly))]))
Sacramento_R3_slope_hourly <- calcslope(xvec, hmat = t(Sacramento_R3_WSE_hourly[,c(3:ncol(Sacramento_R3_WSE_hourly))]))
Sacramento_R3_slope_hourly <- na.replace(Sacramento_R3_slope_hourly, mean(Sacramento_R3_slope_hourly))
Sacramento_R3_slope_hourly[1,] <- colMeans(Sacramento_R3_slope_hourly, na.rm = TRUE)

Sacramento_R3_WSE_15_min <- readRDS("../input/TOWNS/WSE/Sacramento_R3_WSE_Q_15_min.rds")
Sacramento_R3_width_15_min <- t(calc_width(h = Sacramento_R3_WSE_15_min[,c(3:ncol(Sacramento_R3_WSE_15_min))], elev_prof = Sacramento_R3_elev_prof, 
                                  upper_l = Sacramento_R3_upper_l, lower_l = Sacramento_R3_lower_l,
                                  lower_r = Sacramento_R3_lower_r, upper_r = Sacramento_R3_upper_r,
                                  scale_prof = Sacramento_R3_scale_x))
Sacramento_R3_dA_15_min <- calcdA_mat(w = Sacramento_R3_width_15_min, h = t(Sacramento_R3_WSE_15_min[,c(3:ncol(Sacramento_R3_WSE_15_min))]))
Sacramento_R3_slope_15_min <- calcslope(xvec, hmat = t(Sacramento_R3_WSE_15_min[,c(3:ncol(Sacramento_R3_WSE_15_min))]))
Sacramento_R3_slope_15_min <- na.replace(Sacramento_R3_slope_15_min, mean(Sacramento_R3_slope_15_min))
Sacramento_R3_slope_15_min[1,] <- colMeans(Sacramento_R3_slope_15_min, na.rm = TRUE)


```





#### format and save bamdata
```{r Sacramento_R3 save, message=FALSE, warning=FALSE}
library(bamr)
Sacramento_R3_bam_daily = bam_data(w = Sacramento_R3_width_daily, s = Sacramento_R3_slope_daily, dA = Sacramento_R3_slope_daily, Qhat = as.numeric(unlist(Sacramento_R3_WSE_daily[,2])))

Sacramento_R3_bam_6_hrs = bam_data(w = Sacramento_R3_width_6_hrs, s = Sacramento_R3_slope_6_hrs, dA = Sacramento_R3_slope_6_hrs, Qhat = as.numeric(unlist(Sacramento_R3_WSE_6_hrs[,2])))

Sacramento_R3_bam_hourly = bam_data(w = Sacramento_R3_width_hourly, s = Sacramento_R3_slope_hourly, dA = Sacramento_R3_slope_hourly, Qhat = as.numeric(unlist(Sacramento_R3_WSE_hourly[,2])))

Sacramento_R3_bam_15_min = bam_data(w = Sacramento_R3_width_15_min, s = Sacramento_R3_slope_15_min, dA = Sacramento_R3_slope_15_min, Qhat = as.numeric(unlist(Sacramento_R3_WSE_15_min[,2])))

saveRDS(Sacramento_R3_bam_daily, "../input/TOWNS/BAMdata/Sacramento_R3_bam_daily.rds")
saveRDS(Sacramento_R3_bam_6_hrs, "../input/TOWNS/BAMdata/Sacramento_R3_bam_6_hrs.rds")
saveRDS(Sacramento_R3_bam_hourly, "../input/TOWNS/BAMdata/Sacramento_R3_bam_hourly.rds")
saveRDS(Sacramento_R3_bam_15_min, "../input/TOWNS/BAMdata/Sacramento_R3_bam_15_min.rds")

```
